\chapter{Параметрична модель наборів даних із зашумленою розміткою і метод їх генерації}
\label{data-arch}
Для систематизованого вивчення впливу рівня шуму в даних, та оцінки відповідного впливу запропонованих рішень, розроблено модель набору даних із зашумленням розмітки семантичної сегментації, що відповідає оцінкам моделей шуму в різних задачах автоматизованого скринінгу. 

На основі проведеного аналізу виявлено, що основними проблемами з розміткою масок сегментації планарних зображень в задачах скринінгу є:

\begin{itemize}
	\item Маски сегментації, що захоплюють сусідні з об'єктом пікселі;
	\item Маски сегментації, що покривають об'єкт не повністю;
	\item Відсутні маски сегментації для деяких об'єктів;
	\item Присутні зайві маски на місцях, де немає об'єктів.
\end{itemize}

Для відображення означених недоліків розмітки, запропоновано штучне введення помилок за допомогою випадкового застосування морфологічних операцій ерозії та дилатації з квадратним ядром до масок сегментації окремих об'єктів перед додаванням їх до загальної маски. 

Операції ерозії та дилатації відповідають неупередженому зашумленню, оскільки за їхнім результатом не можна відновити вихідну конфігурацію маски \cite{https://arxiv.org/pdf/2107.02189.pdf}. Також, означені операції реалізують зашумлення, що залежать від ознак, оскільки нерівномірно модифікують тонкі та більш товсті лінії та порожнини. 

На відміну від геометричних перетворень маски, включення, або невключення пікселів з граничних регіонів маски є частішим випадком зашумлення розмітки \cite{smith}. 

\section{Модель набору даних із зашумленою розміткою}

Запропонована модель має наступні параметри:

\begin{itemize}
	\item Набір зображень фону $\mathcal{X}_{b}$
	\item Набір зображень об'єктів $\mathcal{X}_{f}$
	\item Набір зображень текстур об'єктів $\mathcal{X}_{tex}$
	\item Кількість зображень в наборі даних $N$
	\item Розмір зображення $S_{img}$ в пікселях
	\item Середній розмір об'єкта $S_{obj}$ в пікселях
	\item Максимальне відхилення розміру об'єкта $\Delta_{max}$ в відсотках
	\item Максимальна кількість об'єктів на зображенні $N_{obj}$
\end{itemize}

На відміну від інших моделей наборів даних, запропонована модель має параметри, що відповідають безпосередньо за зашумлення масок сегментації:

\begin{itemize}
	\item Ймовірності ерозії та дилатації маски кожного з об'єктів $P_e$ та $P_d$
	\item Розміри ядер ерозії та дилатації масок всіх об'єктів $S_e$ та $S_d$	
\end{itemize}



\section{Метод генерації наборів даних}

Запропоновано метод контрольованої генерації як зображень, так і масок сегментації що модифікуються відповідно до випадково обраних недоліків.

На основі параметричної моделі генеруються навчальний та тестовий набори даних, всі зображення в наборах генеруються незалежно.

Контрольована генерація зображень виконується в два етапи: генерація фону та розташування на ньому довільної кількості об'єктів. Для генерації фону можуть бути використані як звичайні натуральні зображення, так і синтетичні текстури, чи заливка константним кольором. В якості об'єктів можуть бути використані зображення з наборів даних MNIST \cite{mnist}, або FashionMNIST \cite{fashionmnist}. 

Використання зазначених наборів даних зумовлено трьома факторами: 

\begin{itemize}
	\item Можливість простого відділення об'єкта від вихідного фону;
	\item Наявність схожих елементів в різних класів (наприклад, цифри 1 та 7, або класи \textit{T-shirt} та \textit{Dress});
	\item Висока точність роботи сучасних нейронних мереж на цих наборах даних, що дозволяє сконцентруватися на впливі шуму в розмітці, замість розпізнавання безпосередньо об'єктів
\end{itemize}

Запропонований метод генерації описується за допомогою алгоритму.  Алгоритм генерації кожного з зображень складається з наступних кроків:

1. Вибір випадкового зображення фону: $x_{bg} \sim \mathcal{X}_b$

2. Вибір кількості об'єктів на зображенні: $n_{obj} \sim \mathcal{U}(1, N_{obj})$

3. Ініціалізація маски сегментації: $M = 0 \; \text{так що} \; M \in \mathcal{R}^{C \times S_{img} \times S_{img}}$

4. Відповідно до кількості зображень $n_{obj}$ виконати наступні кроки:

\qquad 4.1 Вибрати розміри об'єкта: $s \sim \mathcal{U}(S_{obj} - \Delta_{max}, S_{obj} + \Delta_{max})$

\qquad 4.2 Вибрати координати розміщення об'єкта: 
\begin{align*}
	i_f &\sim \mathcal{U}(0, S_{img} - s)\\
	j_f &\sim \mathcal{U}(0, S_{img} - s)
\end{align*}

\qquad 4.3 Вибрати зображення об'єкта $x_{fg} \sim \mathcal{X}_f$ та відповідний клас об'єкта $c_{fg} \sim \mathcal{Y}_f$

\qquad 4.4 Змінити розмір зображення об'єкта за допомогою білінійної інтерполяції: 
\begin{align*}
	\hat{x}_{fg} = R_{bilinear}(x_{fg})
\end{align*}

\qquad 4.5 Вибрати зображення текстури $x_{tex} \sim \mathcal{X}_{tex}$

\qquad 4.6 Модифікувати зображення об'єкта за допомогою текстури:
	\begin{equation*}
		\hat{x}_{fg} = x_{fg} \circ x_{tex}[i_f:i_f+s, j_f:j_f+s]
	\end{equation*}

\qquad 4.7 Розмістити зображення об'єкта на зображенні фону:
	\begin{equation*}
		x_{bg}[i_f:i_f+s, j_f:j_f+s] = (1 - x_{fg}) \circ x_{bg} + \hat{x}_{fg}
	\end{equation*}

\qquad 4.8 Сформувати маску сегментації об'єкта: 
	\begin{equation*}
		M_{seg} = x_{fg} > \theta_{seg}
	\end{equation*}
\qquad де $\theta_{seg}$ - поріг бінаризації вихідного зображення об'єкта. Для набору даних MNIST $\theta_{seg} = 0.2$, для набору даних FashionMNIST $\theta_{seg} = 0.1$.

\qquad 4.9 Модифікувати маску сегментації відповідно до необхідного рівня помилок:
	\begin{equation*}
	M_{seg} = 
	\begin{cases}
		M_{seg} \oplus K^{S_d \times S_d} &\text{ якщо } p_d \sim \mathcal{U}(0, 1) < P_d\\
		M_{seg} \ominus K^{S_e \times S_e} &\text{ якщо } p_e \sim \mathcal{U}(0, 1) < P_e
	\end{cases}
	\end{equation*}
\qquad де $K^{S_d \times S_d}$ - матриця ядра $K^{S_e \times S_e}$ - матриця ядра ерозії.

\qquad 4.10 Розмістити модифіковану маску сегментації об'єкта на загальному зображенні маски сегментації:
	\begin{equation*}
		M[c_{fg}, i_f:i_f+s, j_f:j_f+s] = max \; \{ M[c_{fg}, i_f:i_f+s, j_f:j_f+s], M_{seg} \}
	\end{equation*}

Завдяки такому варіанту генерації, можливо отримання безлічі наборів даних із схожими характеристиками, що дозволяє використовувати непараметричні статистичні методи, такі як бутстрепінг для оцінки моделей. На практиці, для генерації різних наборів даних, достатньо зміни ініціалізації генератора випадкових чисел.

\section{Види згенерованих зображень}

В даному розділі продемонстровано згенеровані зображення та відповідні маски сегментації для різних налаштувань моделі. 

За допомогою моделі можна генерувати набори даних з досить різноманітними характеристиками. На рисунках \ref{fig:mnist_clear_bw} та \ref{fig:fmnist_clear_bw} зображено найпростіший випадок для генерації за допомогою моделі: заповнення фону та об'єктів константними значеннями (0 і 1) відповідно.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_clear_bw.png}
	\caption{Об'єкти MNIST, фон: константний, колір об'єктів: білий}
	\label{fig:mnist_clear_bw}
\end{figure} 

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/fmnist_clear_bw.png}
	\caption{Об'єкти FashionMNIST, фон: константний, колір об'єктів: білий}
	\label{fig:fmnist_clear_bw}
\end{figure} 

На рисунках \ref{fig:mnist_clear_imagenette} та \ref{fig:fmnist_clear_imagenette} зображено фон з використанням зображення з набору даних Imagenette та заповнення об'єктів константним значенням 1.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_clear_imagenette.png}
	\caption{Об'єкти MNIST, фон: Imagenette, колір об'єктів: білий}
	\label{fig:mnist_clear_imagenette}
\end{figure} 


\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/fmnist_clear_imagenette.png}
	\caption{Об'єкти FashionMNIST, фон: Imagenette, колір об'єктів: білий}
	\label{fig:fmnist_clear_imagenette}
\end{figure} 

На рисунках \ref{fig:mnist_clear_imagenette_black} та \ref{fig:fmnist_clear_imagenette_black} зображено фон з використанням зображення з набору даних Imagenette та заповнення об'єктів константним значенням 0.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_clear_imagenette_black.png}
	\caption{Об'єкти MNIST, фон: Imagenette, колір об'єктів: чорний}
	\label{fig:mnist_clear_imagenette_black}
\end{figure} 


\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/fmnist_clear_imagenette_black.png}
	\caption{Об'єкти FashionMNIST, фон: Imagenette, колір об'єктів: чорний}
	\label{fig:fmnist_clear_imagenette_black}
\end{figure} 

На рисунках \ref{fig:mnist_textured_imagenette} зображено найскладніший варіант набору даних: як фон, так і текстури об'єктів взято з набору даних Imagenette.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_textured_imagenette.png}
	\caption{Об'єкти MNIST, фон: Imagenette, текстури об'єктів: Imagenette}
	\label{fig:mnist_textured_imagenette}
\end{figure} 

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/fmnist_textured_imagenette.png}
	\caption{Об'єкти FashionMNIST, фон: Imagenette, текстури об'єктів: Imagenette}
	\label{fig:fmnist_textured_imagenette}
\end{figure} 


Для наочності, модифікації масок сегментації показано на простих зображеннях з константним кольором фону та об'єктів.

На рисунку \ref{fig:mnist_erode_50} зображено вихідне зображення, маску сегментації з ерозією ядром $3 \times 3$ та їх комбінацію для наочності.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_erode_50.png}
	\caption{Об'єкти MNIST, ерозія маски ядром $3 \times 3$}
	\label{fig:mnist_erode_50}
\end{figure} 

На рисунку \ref{fig:mnist_dilate_50} зображено вихідне зображення, маску сегментації з дилатацією ядром $3 \times 3$ та їх комбінацію для наочності.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_dilate_50.png}
	\caption{Об'єкти MNIST, дилатація маски ядром $3 \times 3$}
	\label{fig:mnist_dilate_50}
\end{figure} 

На рисунку \ref{fig:mnist_erode_dilate_50} зображено вихідне зображення, маску сегментації з дилатацією та ерозією ядром $3 \times 3$ та їх комбінацію для наочності.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_erode_dilate_50.png}
	\caption{Об'єкти MNIST, ерозія та дилатація маски ядром $3 \times 3$}
	\label{fig:mnist_erode_dilate_50}
\end{figure} 

Також, при виборі розмірів  ядер ерозії потрібно бути уважним до вихідних масок - дуже великі ядра ерозії можуть знищити маску сегментації для об'єкта. На рисунку \ref{fig:mnist_erode_7x7} зображено вихідне зображення, маску сегментації з ерозією ядром $7 \times 7$ та їх комбінацію для наочності.

\begin{figure}[H]
	\centering
	\includegraphics[width=16cm]{generated_model_images/mnist_erode_7x7.png}
	\caption{Об'єкти MNIST, ерозія маски ядром $7 \times 7$}
	\label{fig:mnist_erode_7x7}
\end{figure} 

\section{Висновки до другого розділу}

У другому розділі представлено параметричну модель наборів даних із зашумленою розміткою для задач сегментації та класифікації, що відповідає оцінкам моделей шуму в різних задачах автоматизованого скринінгу, а також метод контрольованої генерації як зображень, так і масок сегментації та міток класів що модифікуються відповідно до випадково обраних недоліків. 

Запропоновано використання модельних наборів даних тестування достовірності моделей та методів навчання глибоких нейронних мереж в задачах класифікації та семантичної сегментації. Тестування виконується в контрольованих умовах за допомогою введення зашумелння в розмітку лише тренувального набору даних, в той час як тестувальних набір даних залишається з точною розміткою. 
